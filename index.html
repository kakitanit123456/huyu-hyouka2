<!doctype html>
<html lang="ja" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>4å¹´ç†ç§‘ è©•ä¾¡è¨˜éŒ²ãƒ„ãƒ¼ãƒ«ï¼ˆå†¬ãƒ—ãƒ­ï¼‰</title>

  <style>
    :root{
      --bg:#0b0c10; --card:#12141a; --card2:#161a22; --text:#e8eef7; --muted:#a9b3c2;
      --line:#232a36; --chip:#1c2330; --btn:#1f2a3a; --accent:#59a8ff;
      --danger:#ff6b6b;
    }
    :root[data-theme="light"]{
      --bg:#f6f7fb; --card:#ffffff; --card2:#f1f3f8; --text:#0c1220; --muted:#4b5565;
      --line:#d9e0ea; --chip:#eef2f8; --btn:#ffffff;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }

    header{
      position:sticky; top:0; z-index:1000;
      background: color-mix(in srgb, var(--bg) 88%, transparent);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    :root[data-theme="light"] header{
      background:rgba(255,255,255,.92);
    }

    .wrap{max-width:1250px;margin:0 auto;padding:14px 14px 22px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grid{display:grid;gap:12px}
    @media (min-width: 920px){ .grid{grid-template-columns: 360px 1fr} }

    .grow{flex:1; min-width:0}
    h1{font-size:16px;margin:0 0 6px 0;letter-spacing:.02em}
    .sub{font-size:12px;color:var(--muted)}
    .hint{font-size:12px;color:var(--muted)}
    .small{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:10px 0}

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    .card.soft{background:var(--card2)}
    .sec-title{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;margin-bottom:8px}
    .sec-title h2{font-size:14px;margin:0}

    .btn{
      background:var(--btn);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      cursor:pointer;
      pointer-events:auto;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{border-color: color-mix(in srgb, var(--line) 40%, #ffffff 30%)}
    .btn.primary{border-color: color-mix(in srgb, var(--accent) 60%, var(--line));}
    .btn.danger{border-color: color-mix(in srgb, var(--danger) 65%, var(--line)); color: color-mix(in srgb, var(--danger) 70%, var(--text));}

    input,select,textarea{
      background:var(--card2);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:10px;
      padding:10px;
      font-size:13px;
      width:100%;
      min-width:0;
    }
    textarea{min-height:84px; resize:vertical}

    /* iPadæ¨ªã§ header ãŒ â€œã‹ã¶ã•ã£ã¦ãƒœã‚¿ãƒ³ãŒæŠ¼ã›ãªã„â€ å¯¾ç­– */
    .headerBar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
      position:relative;
      z-index:2000;
    }
    .headerLeft{flex:1 1 auto; min-width:0}
    .headerLeft h1{overflow-wrap:anywhere}
    .headerActions{flex:0 0 auto; display:flex; gap:10px; flex-wrap:wrap; z-index:3000}
    #btnTheme{position:relative; z-index:4000; pointer-events:auto}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border:1px solid var(--line); border-radius:999px;
      background:var(--chip); color:var(--muted); font-size:12px;
    }
    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      padding:2px 8px; border-radius:999px; border:1px solid var(--line);
      background:var(--chip); color:var(--muted); font-size:12px;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="headerBar">
      <div class="headerLeft">
        <h1>4å¹´ç†ç§‘ è©•ä¾¡è¨˜éŒ²ãƒ„ãƒ¼ãƒ«ï¼ˆå†¬ã®è‡ªç„¶æ¢ç©¶ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰</h1>
        <div class="sub">localStorageã®ã¿ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼‰ï¼åŒæœŸï¼šplanï¼‹statusã®ã¿ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—å†…ï¼‰</div>
      </div>

      <div class="headerActions">
        <button class="btn" id="btnTheme" type="button">ğŸŒ™</button>
        <button class="btn" id="btnExport" type="button">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button class="btn" id="btnImport" type="button">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <button class="btn danger" id="btnReset" type="button">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap grid">
  <!-- å·¦ï¼šåç°¿ -->
  <div class="card">
    <div class="sec-title">
      <h2>åç°¿</h2>
      <span class="hint">å…ç«¥ã®è¿½åŠ ï¼å‰Šé™¤ï¼ˆPart2ã§å®Ÿè£…ï¼‰</span>
    </div>

    <div class="row">
      <select id="studentSelect" class="grow">
        <option value="(sample)">ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰å…ç«¥A</option>
      </select>
      <button class="btn" id="btnDeleteStudent" type="button">å‰Šé™¤</button>
    </div>

    <div class="row">
      <input id="newStudentName" class="grow" placeholder="è¿½åŠ ã™ã‚‹å…ç«¥åï¼ˆä¾‹ï¼šå±±ç”° å¤ªéƒï¼‰" />
      <button class="btn primary" id="btnAddStudent" type="button">è¿½åŠ </button>
    </div>

    <div class="hr"></div>

    <div class="sec-title">
      <h2>ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®šï¼ˆ2ãƒ»2ãƒ»3ï¼‰</h2>
      <span class="hint">G1/G2/G3ï¼‹æœªè¨­å®š</span>
    </div>

    <div class="row">
      <select id="groupSelect" class="grow">
        <option value="">ï¼ˆæœªè¨­å®šï¼‰</option>
        <option value="G1">G1ï¼ˆ2äººï¼‰</option>
        <option value="G2">G2ï¼ˆ2äººï¼‰</option>
        <option value="G3">G3ï¼ˆ3äººï¼‰</option>
      </select>
      <button class="btn" id="btnAutoGroup" type="button">è‡ªå‹•(2ãƒ»2ãƒ»3)</button>
    </div>

    <div class="small" id="groupCount" style="margin-top:6px">
      äººæ•°ï¼šG1=0 / G2=0 / G3=0ï¼ˆæœª=0ï¼‰
    </div>

    <div class="hr"></div>

    <div class="sec-title">
      <h2>åŒæœŸè¨­å®š</h2>
      <span class="hint">åŒæœŸã™ã‚‹ã®ã¯ planï¼‹status ã®ã¿</span>
    </div>

    <label class="pill" style="width:100%; justify-content:space-between">
      <span>åŒæœŸã‚’æœ‰åŠ¹ã«ã™ã‚‹</span>
      <input id="syncToggle" type="checkbox" style="width:auto" />
    </label>

    <div class="small" id="syncInfo" style="margin-top:8px">
      ä¾‹ï¼šå¯¾è±¡ã‚°ãƒ«ãƒ¼ãƒ—ï¼šG1ï¼ˆåŒæœŸå…ˆ 2äººï¼‰ï¼æœªè¨­å®šãªã‚‰åŒæœŸãªã—
    </div>
  </div>

  <!-- å³ï¼šå…¥åŠ›ã‚¨ãƒªã‚¢ -->
  <div class="card soft">
    <div class="sec-title">
      <h2>è¨˜éŒ²</h2>
      <span class="hint">æå‡ºç‰©ãƒ»ç”»åƒã¯å€‹äººï¼ˆåŒæœŸã—ãªã„ï¼‰</span>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div style="font-size:14px;font-weight:700">è¨ˆç”»ï¼ˆplanï¼‰ï¼é€²æ—ï¼ˆstatusï¼‰</div>
        <span class="badge">åŒæœŸå¯¾è±¡</span>
      </div>

      <div class="sub" style="margin-top:10px">è¨ˆç”»ï¼ˆplanï¼‰</div>
      <input id="planInput" placeholder="ä¾‹ï¼šè¦³å¯Ÿã‚«ãƒ¼ãƒ‰ã€å†™çœŸã€ç™ºè¡¨æº–å‚™ ãªã©" />

      <div class="sub" style="margin-top:10px">é€²æ—ï¼ˆstatusï¼‰</div>
      <select id="statusSelect">
        <option value="">ï¼ˆæœªè¨­å®šï¼‰</option>
        <option value="æœª">æœª</option>
        <option value="é€”ä¸­">é€”ä¸­</option>
        <option value="å®Œäº†">å®Œäº†</option>
      </select>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div style="font-size:14px;font-weight:700">æå‡ºç‰©ãƒ»ç”»åƒï¼ˆå€‹äººï¼‰</div>
        <span class="badge">åŒæœŸã—ãªã„</span>
      </div>

      <div class="sub" style="margin-top:10px">æå‡ºç‰©ãƒ¡ãƒ¢ï¼ˆå€‹äººï¼‰</div>
      <textarea id="noteInput" placeholder="ä¾‹ï¼šæå‡ºæ¸ˆã¿ã€å†æå‡ºã€å†™çœŸOK ãªã©ï¼ˆå€‹äººãƒ¡ãƒ¢ï¼‰"></textarea>

      <div class="sub" style="margin-top:10px">ç”»åƒï¼ˆå€‹äººãƒ»1æšï¼‰</div>
      <div class="row">
        <input id="photoInput" type="file" accept="image/*" />
        <button class="btn" id="btnClearPhoto" type="button">ç”»åƒã‚’å‰Šé™¤</button>
      </div>

      <img id="photoPreview" alt="" style="width:100%;max-height:320px;object-fit:contain;border:1px solid var(--line);border-radius:12px;display:none;margin-top:8px" />
      <div class="small" style="margin-top:8px">â€» Part2ã§ä¿å­˜ï¼ˆlocalStorageï¼‰ã‚’å®Ÿè£…ã—ã¾ã™</div>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="font-size:14px;font-weight:700;margin-bottom:6px">ã“ã®æ®µéšã®ç¢ºèª</div>
      <ul style="margin:0; padding-left:18px; color:var(--muted); line-height:1.7; font-size:13px">
        <li>å³ä¸Šã®ğŸŒ™/â˜€ï¸ã§ãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹</li>
        <li>iPadæ¨ªã§ã‚‚å³ä¸Šãƒœã‚¿ãƒ³ãŒæŠ¼ã›ã‚‹ï¼ˆheaderãŒã‹ã¶ã‚‰ãªã„ï¼‰</li>
        <li>ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„</li>
      </ul>
    </div>
  </div>
</div>

<script>
  // =========================
  // Part3 (3/3): ç”»åƒä¿å­˜ + Export/Import + å®Œæˆç‰ˆ
  // =========================

  // ===== Storage keys =====
  const THEME_KEY = "rika4_theme_v3";
  const DATA_KEY  = "rika4_data_v2";     // v2: photosByStudent ã‚’å«ã‚€
  const SYNC_KEY  = "rika4_sync_enabled_v1";

  // ===== DOM helpers =====
  const $ = (id)=> document.getElementById(id);

  // ===== Theme =====
  function applyTheme(mode){
    document.documentElement.dataset.theme = mode;
    localStorage.setItem(THEME_KEY, mode);

    const btn = $("btnTheme");
    if(btn){
      btn.textContent = (mode === "light") ? "â˜€ï¸" : "ğŸŒ™";
      btn.title = (mode === "light") ? "ãƒ€ãƒ¼ã‚¯ã«åˆ‡ã‚Šæ›¿ãˆ" : "ãƒ©ã‚¤ãƒˆã«åˆ‡ã‚Šæ›¿ãˆ";
    }
  }
  function toggleTheme(){
    const cur = document.documentElement.dataset.theme || "dark";
    applyTheme(cur === "dark" ? "light" : "dark");
  }

  // ===== Data model =====
  const defaultData = {
    students: ["å…ç«¥A","å…ç«¥B","å…ç«¥C","å…ç«¥D","å…ç«¥E","å…ç«¥F","å…ç«¥G"],
    studentGroup: {},        // { name: "G1"|"G2"|"G3"|"" }
    progressByStudent: {},   // { name: { plan:"", status:"", note:"" } }
    photosByStudent: {}      // { name: "data:image/jpeg;base64,..." }
  };

  function clone(obj){ return JSON.parse(JSON.stringify(obj)); }

  function ensureStudentRow(d, name){
    d.studentGroup = d.studentGroup || {};
    d.progressByStudent = d.progressByStudent || {};
    d.photosByStudent = d.photosByStudent || {};

    if(d.studentGroup[name] == null) d.studentGroup[name] = "";

    if(d.progressByStudent[name] == null){
      d.progressByStudent[name] = { plan:"", status:"", note:"" };
    }else{
      // æ—§ãƒ‡ãƒ¼ã‚¿æ•‘æ¸ˆ
      if(d.progressByStudent[name].plan == null) d.progressByStudent[name].plan = "";
      if(d.progressByStudent[name].status == null) d.progressByStudent[name].status = d.progressByStudent[name].done || "";
      if(d.progressByStudent[name].note == null) d.progressByStudent[name].note = "";
    }

    // photosByStudent[name] ã¯æœªè¨­å®šã§ã‚‚OK
  }

  // ---- migrate: v1(DATA_KEY=riks4_data_v1) -> v2(DATA_KEY=riks4_data_v2)
  function migrateFromV1IfNeeded(){
    const oldKey = "rika4_data_v1";
    const hasNew = localStorage.getItem(DATA_KEY);
    const hasOld = localStorage.getItem(oldKey);
    if(hasNew || !hasOld) return;

    try{
      const d = JSON.parse(hasOld);
      if(!d || typeof d !== "object") return;
      if(!d.photosByStudent) d.photosByStudent = {};
      localStorage.setItem(DATA_KEY, JSON.stringify(d));
      // oldKey ã¯æ®‹ã—ã¦ã‚‚è‰¯ã„ãŒæ··ä¹±é˜²æ­¢ã§æ¶ˆã™
      localStorage.removeItem(oldKey);
    }catch(_e){
      // å¤±æ•—ã—ã¦ã‚‚ä½•ã‚‚ã—ãªã„
    }
  }

  function loadData(){
    try{
      migrateFromV1IfNeeded();

      const raw = localStorage.getItem(DATA_KEY);
      if(!raw){
        const d = clone(defaultData);
        d.students.forEach(n=> ensureStudentRow(d, n));
        return d;
      }

      const d = JSON.parse(raw);

      if(!Array.isArray(d.students)) d.students = clone(defaultData.students);
      if(!d.studentGroup || typeof d.studentGroup !== "object") d.studentGroup = {};
      if(!d.progressByStudent || typeof d.progressByStudent !== "object") d.progressByStudent = {};
      if(!d.photosByStudent || typeof d.photosByStudent !== "object") d.photosByStudent = {};

      if(d.students.length === 0) d.students = clone(defaultData.students);
      d.students.forEach(n=> ensureStudentRow(d, n));
      return d;
    }catch(e){
      console.warn(e);
      const d = clone(defaultData);
      d.students.forEach(n=> ensureStudentRow(d, n));
      return d;
    }
  }

  function saveData(){
    localStorage.setItem(DATA_KEY, JSON.stringify(state.data));
  }

  const state = {
    data: loadData(),
    currentStudent: null
  };

  // ===== Group helpers =====
  function getGroupMembers(studentName){
    const g = state.data.studentGroup?.[studentName] || "";
    if(!g) return [studentName];
    return state.data.students.filter(n => (state.data.studentGroup?.[n] || "") === g);
  }

  function isSyncEnabled(){
    return localStorage.getItem(SYNC_KEY) === "1";
  }

  // ===== Sync: plan + status only =====
  function syncProgressToGroup(fromStudent){
    const members = getGroupMembers(fromStudent);
    ensureStudentRow(state.data, fromStudent);

    const src = state.data.progressByStudent[fromStudent];

    members.forEach(m=>{
      ensureStudentRow(state.data, m);
      const prev = state.data.progressByStudent[m] || {};
      state.data.progressByStudent[m] = {
        plan: src.plan || "",
        status: src.status || "",
        note: prev.note || "" // note ã¯åŒæœŸã—ãªã„
      };
    });

    saveData();
  }

  // ===== UI render: student select =====
  function renderStudentSelect(){
    const sel = $("studentSelect");
    if(!sel) return;

    sel.innerHTML = "";
    state.data.students.forEach(name=>{
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
    });

    if(!state.currentStudent) state.currentStudent = state.data.students[0];
    sel.value = state.currentStudent;

    sel.onchange = ()=>{
      state.currentStudent = sel.value;
      ensureStudentRow(state.data, state.currentStudent);
      saveData();
      renderAllForCurrent();
    };
  }

  // ===== UI render: group =====
  function renderGroupUI(){
    const sel = $("groupSelect");
    const cnt = $("groupCount");
    if(!sel || !cnt) return;

    const cur = state.currentStudent;
    ensureStudentRow(state.data, cur);

    sel.value = state.data.studentGroup?.[cur] || "";

    const counts = {G1:0, G2:0, G3:0, "":0};
    state.data.students.forEach(n=>{
      const g = state.data.studentGroup?.[n] || "";
      counts[g] = (counts[g] ?? 0) + 1;
    });
    cnt.textContent = `äººæ•°ï¼šG1=${counts.G1} / G2=${counts.G2} / G3=${counts.G3}ï¼ˆæœª=${counts[""]}ï¼‰`;

    sel.onchange = ()=>{
      state.data.studentGroup[cur] = sel.value || "";
      saveData();
      renderGroupUI();
      renderSyncInfo();
    };
  }

  function autoAssignGroups223(){
    const list = state.data.students.slice();
    const plan = ["G1","G1","G2","G2","G3","G3","G3"];
    state.data.studentGroup = state.data.studentGroup || {};
    list.forEach((name, i)=>{
      state.data.studentGroup[name] = plan[i] || "G3";
    });
    saveData();
    renderGroupUI();
    renderSyncInfo();
  }

  // ===== UI: sync toggle + info =====
  function bindSyncToggle(){
    const t = $("syncToggle");
    if(!t) return;
    t.checked = isSyncEnabled();

    t.onchange = ()=>{
      localStorage.setItem(SYNC_KEY, t.checked ? "1" : "0");
      renderSyncInfo();
    };
  }

  function renderSyncInfo(){
    const info = $("syncInfo");
    const t    = $("syncToggle");
    if(!info || !t) return;

    const cur = state.currentStudent;
    const g = state.data.studentGroup?.[cur] || "";
    const members = getGroupMembers(cur);

    if(!g){
      info.textContent = "ã‚°ãƒ«ãƒ¼ãƒ—æœªè¨­å®šï¼šã“ã®å…ç«¥ã ã‘ï¼ˆåŒæœŸãªã—ï¼‰";
      return;
    }

    info.textContent = t.checked
      ? `åŒæœŸONï¼šå¯¾è±¡ã‚°ãƒ«ãƒ¼ãƒ— ${g}ï¼ˆåŒæœŸå…ˆ ${members.length}äººï¼‰`
      : `åŒæœŸOFFï¼šå¯¾è±¡ã‚°ãƒ«ãƒ¼ãƒ— ${g}ï¼ˆåŒæœŸã¯ã—ãªã„ï¼‰`;
  }

  // ===== UI: plan/status/note =====
  function renderProgressUI(){
    const planEl   = $("planInput");
    const statusEl = $("statusSelect");
    const noteEl   = $("noteInput");
    if(!planEl || !statusEl || !noteEl) return;

    const cur = state.currentStudent;
    ensureStudentRow(state.data, cur);

    planEl.value   = state.data.progressByStudent[cur].plan || "";
    statusEl.value = state.data.progressByStudent[cur].status || "";
    noteEl.value   = state.data.progressByStudent[cur].note || "";
  }

  function bindProgressInputs(){
    const planEl   = $("planInput");
    const statusEl = $("statusSelect");
    const noteEl   = $("noteInput");
    if(!planEl || !statusEl || !noteEl) return;

    const saveAndMaybeSync = ()=>{
      saveData();
      if(isSyncEnabled()){
        syncProgressToGroup(state.currentStudent);
        renderProgressUI(); // åŒæœŸå¾Œã®å€¤ã§æƒãˆã‚‹
      }
      renderSyncInfo();
    };

    planEl.oninput = ()=>{
      const cur = state.currentStudent;
      ensureStudentRow(state.data, cur);
      state.data.progressByStudent[cur].plan = planEl.value;
      saveAndMaybeSync();
    };

    statusEl.onchange = ()=>{
      const cur = state.currentStudent;
      ensureStudentRow(state.data, cur);
      state.data.progressByStudent[cur].status = statusEl.value;
      saveAndMaybeSync();
    };

    noteEl.oninput = ()=>{
      const cur = state.currentStudent;
      ensureStudentRow(state.data, cur);
      state.data.progressByStudent[cur].note = noteEl.value;
      saveData(); // noteã¯åŒæœŸã—ãªã„
    };
  }

  // ===== UI: add/delete student =====
  function bindAddStudent(){
    const btn = $("btnAddStudent");
    const inp = $("newStudentName");
    if(!btn || !inp) return;

    const add = ()=>{
      const name = (inp.value || "").trim();
      if(!name) return alert("å…ç«¥åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      if(state.data.students.includes(name)) return alert("åŒåã®å…ç«¥ãŒã™ã§ã«ã„ã¾ã™ã€‚");

      state.data.students.push(name);
      ensureStudentRow(state.data, name);
      state.currentStudent = name;
      inp.value = "";
      saveData();

      renderStudentSelect();
      renderAllForCurrent();
    };

    btn.onclick = add;
    inp.onkeydown = (e)=>{ if(e.key === "Enter") add(); };
  }

  function bindDeleteStudent(){
    const btn = $("btnDeleteStudent");
    if(!btn) return;

    btn.onclick = ()=>{
      const cur = state.currentStudent;
      if(!cur) return;

      if(!confirm(`ã€Œ${cur}ã€ã‚’åç°¿ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã®å…ç«¥ã®è¨˜éŒ²ãƒ»ç”»åƒã‚‚ç«¯æœ«å†…ã‹ã‚‰æ¶ˆãˆã¾ã™ï¼‰`)) return;

      state.data.students = state.data.students.filter(n => n !== cur);
      if(state.data.studentGroup) delete state.data.studentGroup[cur];
      if(state.data.progressByStudent) delete state.data.progressByStudent[cur];
      if(state.data.photosByStudent) delete state.data.photosByStudent[cur];

      if(state.data.students.length === 0){
        state.data.students = clone(defaultData.students);
        state.data.students.forEach(n=> ensureStudentRow(state.data, n));
      }

      state.currentStudent = state.data.students[0];
      saveData();

      renderStudentSelect();
      renderAllForCurrent();
    };
  }

  // ===== Photo (1 per student) =====
  function renderPhotoPreview(){
    const img = $("photoPreview");
    if(!img) return;

    const cur = state.currentStudent;
    const url = state.data.photosByStudent?.[cur];

    if(url){
      img.src = url;
      img.style.display = "block";
    }else{
      img.removeAttribute("src");
      img.style.display = "none";
    }
  }

  function readAsDataURL(file){
    return new Promise((resolve, reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(String(r.result || ""));
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  function resizeDataURL(dataUrl, maxW){
    return new Promise((resolve)=>{
      const img = new Image();
      img.onload = ()=>{
        const scale = Math.min(1, maxW / img.width);
        const nw = Math.max(1, Math.round(img.width * scale));
        const nh = Math.max(1, Math.round(img.height * scale));

        const canvas = document.createElement("canvas");
        canvas.width = nw;
        canvas.height = nh;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, nw, nh);

        // JPEGã§å®¹é‡ç¯€ç´„
        resolve(canvas.toDataURL("image/jpeg", 0.82));
      };
      img.onerror = ()=> resolve(dataUrl);
      img.src = dataUrl;
    });
  }

  function bindPhoto(){
    const input = $("photoInput");
    const btnClear = $("btnClearPhoto");
    if(!input || !btnClear) return;

    input.onchange = async ()=>{
      try{
        const file = input.files && input.files[0];
        if(!file) return;

        // æ³¨æ„: localStorageå®¹é‡åˆ¶é™ï¼ˆç›®å®‰æ•°MBï¼‰ã«æ³¨æ„
        const dataUrl = await readAsDataURL(file);
        const resized = await resizeDataURL(dataUrl, 1280);

        const cur = state.currentStudent;
        ensureStudentRow(state.data, cur);

        state.data.photosByStudent[cur] = resized;
        saveData();
        renderPhotoPreview();
      }catch(e){
        console.warn(e);
        alert("ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆå®¹é‡ãŒè¶³ã‚Šãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰");
      }finally{
        input.value = "";
      }
    };

    btnClear.onclick = ()=>{
      const cur = state.currentStudent;
      if(!confirm("ã“ã®å…ç«¥ã®ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      if(state.data.photosByStudent) delete state.data.photosByStudent[cur];
      saveData();
      renderPhotoPreview();
    };
  }

  // ===== Export / Import =====
  function downloadText(filename, text){
    const blob = new Blob([text], {type:"application/json"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(url);
  }

  function makeExportFilename(){
    const now = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    const y = now.getFullYear();
    const m = pad(now.getMonth()+1);
    const d = pad(now.getDate());
    const hh = pad(now.getHours());
    const mm = pad(now.getMinutes());
    return `rika4_winter_export_${y}${m}${d}_${hh}${mm}.json`;
  }

  function bindExport(){
    const btn = $("btnExport");
    if(!btn) return;

    btn.onclick = ()=>{
      // ä¿å­˜ã‚’ç¢ºå®Ÿã«
      saveData();
      downloadText(makeExportFilename(), JSON.stringify(state.data, null, 2));
    };
  }

  function bindImport(){
    const btn = $("btnImport");
    if(!btn) return;

    // hidden file input
    let fileInput = document.createElement("input");
    fileInput.type = "file";
    fileInput.accept = "application/json";
    fileInput.style.display = "none";
    document.body.appendChild(fileInput);

    fileInput.onchange = async ()=>{
      try{
        const file = fileInput.files && fileInput.files[0];
        if(!file) return;

        const text = await file.text();
        const obj = JSON.parse(text);

        if(!obj || typeof obj !== "object" || !Array.isArray(obj.students)){
          alert("å½¢å¼ãŒé•ã†ãŸã‚èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚");
          return;
        }

        // è¶³ã‚Šãªã„ã‚­ãƒ¼ã‚’è£œã†
        if(!obj.studentGroup || typeof obj.studentGroup !== "object") obj.studentGroup = {};
        if(!obj.progressByStudent || typeof obj.progressByStudent !== "object") obj.progressByStudent = {};
        if(!obj.photosByStudent || typeof obj.photosByStudent !== "object") obj.photosByStudent = {};

        obj.students.forEach(n=> ensureStudentRow(obj, n));

        state.data = obj;
        state.currentStudent = state.data.students[0];

        saveData();
        renderStudentSelect();
        renderAllForCurrent();

        alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚");
      }catch(e){
        console.warn(e);
        alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆJSONãŒå£Šã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚");
      }finally{
        fileInput.value = "";
      }
    };

    btn.onclick = ()=>{
      if(!confirm("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ç¶šã‘ã¾ã™ã‹ï¼Ÿ")) return;
      fileInput.click();
    };
  }

  // ===== Reset =====
  function bindReset(){
    const btn = $("btnReset");
    if(!btn) return;

    btn.onclick = ()=>{
      if(!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆç«¯æœ«å†… localStorage ã®ã¿ï¼‰")) return;
      localStorage.removeItem(DATA_KEY);
      localStorage.removeItem(SYNC_KEY);
      // ãƒ†ãƒ¼ãƒã¯æ®‹ã™ï¼ˆå¥½ã¿ï¼‰
      location.reload();
    };
  }

  // ===== Auto group button =====
  function bindAutoGroup(){
    const btn = $("btnAutoGroup");
    if(!btn) return;

    btn.onclick = ()=>{
      if(!confirm("å…ç«¥é †ã« 2ãƒ»2ãƒ»3ï¼ˆG1,G2,G3ï¼‰ã§è‡ªå‹•å‰²ã‚Šå½“ã¦ã—ã¾ã™ã‹ï¼Ÿ")) return;
      autoAssignGroups223();
    };
  }

  // ===== Render all for current student =====
  function renderAllForCurrent(){
    renderGroupUI();
    renderSyncInfo();
    renderProgressUI();
    renderPhotoPreview();
  }

  // ===== init =====
  document.addEventListener("DOMContentLoaded", ()=>{
    // theme
    applyTheme(localStorage.getItem(THEME_KEY) || "dark");
    const tbtn = $("btnTheme");
    if(tbtn) tbtn.addEventListener("click", toggleTheme);

    // init
    state.currentStudent = state.data.students[0];
    ensureStudentRow(state.data, state.currentStudent);
    saveData();

    // render
    renderStudentSelect();
    renderAllForCurrent();

    // bind
    bindSyncToggle();
    bindAddStudent();
    bindDeleteStudent();
    bindAutoGroup();
    bindProgressInputs();
    bindPhoto();
    bindExport();
    bindImport();
    bindReset();
  });
</script>
</body>
</html>
